# catr R Package Documentation

> **AI Disclosure**: This documentation was generated by AI with Cursor.

## Overview

The `catr` package is an R package designed to facilitate execution of default or custom runs of the EPA MOVES (Motor Vehicle Emissions Simulator) software. The package provides functions for runspec generation, data formatting, database operations, Google Cloud Storage integration, and MOVES data processing.

**Package Version**: 0.2.0  
**Maintainer**: Timothy Fraser <tmf77@cornell.edu>  
**License**: GPL-3

For installation instructions, see the [main README](../README.md#download-the-catr-package-using).

## Directory Structure

```
catr/
├── R/                    # Core R functions (19 files)
├── data/                 # Package data files (.rda format)
├── data_raw/             # Raw data sources and build scripts
├── man/                  # Roxygen-generated documentation
├── volume/               # Example configuration files
├── z/                    # Test files
├── DESCRIPTION           # Package metadata
├── NAMESPACE             # Package namespace definitions
├── LICENSE               # License file
└── dev.R                 # Development/build script
```

## Core Components

### R Functions (`R/`)

The package contains 19 R source files organized by functionality:

#### Runspec Generation
- **[custom_rs.R](../catr/R/custom_rs.R)** - Creates custom runspec XML files based on input parameters (geoid, year, pollutants, etc.)
- **[translate_rs.R](../catr/R/translate_rs.R)** - Translates runspec XML files into simplified R lists for programmatic use
- **[rs_to_parameters.R](../catr/R/rs_to_parameters.R)** - Converts runspec parameters to JSON format

#### Data Formatting
- **[format_moves.R](../catr/R/format_moves.R)** - Formats MOVES output data into CAT (Climate Action in Transportation) format
- **[format_data.R](../catr/R/format_data.R)** - Formats MOVES output data from database into structured format
- **[postprocess_format.R](../catr/R/postprocess_format.R)** - Post-processing wrapper for formatting MOVES output

#### Database Operations
- **[connect.R](../catr/R/connect.R)** - Establishes connections to MariaDB/MySQL databases
- **[get_data.R](../catr/R/get_data.R)** - Retrieves data from MOVES output tables

#### Google Cloud Storage
- **[api_functions.R](../catr/R/api_functions.R)** - Functions for Google Cloud Storage operations:
  - `authorize()` - Authenticate with Google Cloud using API key JSON
  - `bucket_create()`, `bucket_delete()`, `bucket_list()` - Bucket management
  - `bucket_upload()`, `bucket_upload_bulk()` - Upload operations
  - `object_list()`, `object_delete()`, `object_delete_bulk()` - Object management
  - `workflow_execute()` - Execute cloud workflows

#### MOVES Data Processing
- **[process_emissions.R](../catr/R/process_emissions.R)** - Processes emissions data for specific geoids and pollutants
- **[process_by.R](../catr/R/process_by.R)** - Processes data by aggregation level (by sourcetype, roadtype, etc.)
- **[process_activity.R](../catr/R/process_activity.R)** - Processes activity data from MOVES output

#### Utility Functions
- **[get_bycats.R](../catr/R/get_bycats.R)** - Gets aggregation category names
- **[get_pollutantprocessassoc.R](../catr/R/get_pollutantprocessassoc.R)** - Gets pollutant-process associations
- **[get_polprocesses.R](../catr/R/get_polprocesses.R)** - Gets pollutant processes
- **[get_roadtypes.R](../catr/R/get_roadtypes.R)** - Gets road type selections
- **[get_vehicleselections.R](../catr/R/get_vehicleselections.R)** - Gets vehicle selections
- **[get_runid.R](../catr/R/get_runid.R)** - Gets MOVES run ID from database
- **[what_level.R](../catr/R/what_level.R)** - Determines geographic level (county/state/nation) from geoid

### Package Data (`data/`)

The package includes pre-processed data files in `.rda` format:

- **by.rda** - Aggregation level definitions
- **fieldtypes.rda** - Field type definitions
- **metadata.rda** - Package metadata
- **projections.rda** - Population projection data
- **reqprocesses.rda** - Required process definitions
- **rs_template.rda** - Base runspec template
- **rs_template_inventory.rda** - Inventory mode runspec template
- **rs_template_rate.rda** - Rate mode runspec template
- **tab_emissionprocess.rda** - Emission process lookup table
- **tab_onroadvehicleselections.rda** - Vehicle selection lookup table
- **tab_pollutant.rda** - Pollutant lookup table
- **tab_pollutantprocessassoc.rda** - Pollutant-process association table
- **tab_roadtypes.rda** - Road type lookup table
- **types.rda** - Type definitions

### Raw Data (`data_raw/`)

Source data and build scripts:

- **make_data.R** - Script to build package data files
- **make_pop.R** - Script to build population projection data
- **make_reqprocesses.R** - Script to build required processes data
- **metadata.R** - Metadata generation script
- **read_it.R** - Data reading utilities
- **example_projections.R** - Example population projections
- **rs_template.xml**, **rs_inventory.xml**, **rs_rate.xml** - Runspec XML templates
- **hauer_county_totpop_SSPs.xlsx** - Population projection source data
- **nhgis0007_csv.zip** - NHGIS census data
- **nhgis0007_ts_nominal_county_codebook.txt** - Codebook for NHGIS data
- **popdynamics-us-county-level-pop-projections-sex-race-age-ssp-2020-2100-data-dictionary-xlsx.xlsx** - Population projection data dictionary
- **popdynamics-us-county-level-pop-projections-sex-race-age-ssp-2020-2100-documentation.pdf** - Population projection documentation

### Example Files (`volume/`)

- **parameters.json** - Example parameters file
- **rs_custom.xml** - Example custom runspec

### Test Files (`z/`)

- **test.xml**, **test_1.xml**, **test_2.xml**, **test_3.xml** - Test runspec files
- **testing_custom_rs.R** - Test script for custom_rs function

## Key Functions

### Creating Runspecs

```r
# Create a custom runspec for a county
catr::custom_rs(
  .geoid = "36109",
  .year = 2020,
  .level = "county",
  .default = FALSE,
  .path = "inputs/rs_custom.xml"
)
```

### Translating Runspecs

```r
# Translate runspec to R list
params <- catr::translate_rs(.runspec = "inputs/rs_custom.xml")
```

### Formatting MOVES Output

```r
# Format MOVES output data
catr::format_moves(
  path = "data.rds",
  path_parameters = "inputs/parameters.json"
)
```

### Database Connections

```r
# Connect to MOVES database
db <- catr::connect(type = "mariadb", "moves")
```

## Package Dependencies

The package depends on:

- **Core**: R (>= 3.5.0)
- **Database**: DBI (>= 1.1.3), RMySQL (>= 0.10.25), RMariaDB (>= 1.2.2)
- **Data Manipulation**: dplyr (>= 1.1.0), tidyr (>= 1.3.0), readr (>= 1.3.1), purrr (>= 1.0.1)
- **Utilities**: stringr (>= 1.5.0), jsonlite (>= 1.6.1), xml2 (>= 1.3.1)
- **Cloud**: googleCloudStorageR (>= 0.7.0), googleAuthR (>= 2.0.1), gargle (>= 1.5.2), httr (>= 1.4.7)

## Usage Workflow

1. **Create Runspec**: Use `custom_rs()` to generate a runspec XML file
2. **Run MOVES**: Execute MOVES using the generated runspec (via Docker container)
3. **Format Output**: Use `format_moves()` or `format_data()` to process MOVES output
4. **Post-process**: Use `postprocess_format()` for final data formatting

## Related Documentation

- [Main README](../README.md)
- [Docker Image Documentation](README_docker_moves.md)
- [Scripts Documentation](README_scripts.md)
- [Development Tools Documentation](README_dev.md)

## Package Development

To build the package, use the [dev.R](../catr/dev.R) script:

```r
# Build package
devtools::document()
devtools::build(path = ".", pkg = getwd(), binary = FALSE)
```

The built package (`catr_0.2.0.tar.gz`) is distributed with the repository and used by the Docker images.

