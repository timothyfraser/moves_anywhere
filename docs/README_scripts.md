# Scripts Directory Documentation

**AI Disclosure**: This documentation was generated by AI with Cursor.

## Overview

The `scripts/` directory contains all execution scripts, task scripts, and adaptation utilities for running MOVES Anywhere. These scripts orchestrate the complete MOVES workflow from input validation through post-processing.

**Location**: `moves_anywhere/scripts/`

## Directory Structure

```
scripts/
├── launch.sh                    # Main execution workflow
├── launch_fuse.sh                # Cloud execution with GCS FUSE
├── launch_runspec.sh             # Runspec generation only
├── task_*.sh                     # Shell task scripts
├── task_*.R                     # R task scripts
├── adapt_*.R                     # Input adaptation scripts
├── adapt_functions.R             # Shared adaptation functions
├── importer.R                    # Data importer utility
├── importer_template.xml         # Importer XML template
├── setenv.R                      # R environment setup
├── make_projections.R            # Population projections
├── validate_*.R                  # Validation scripts
├── test.sh                       # Testing script
├── reference/                    # Reference data files
│   ├── README.md
│   ├── hpmsvtypeyear.csv
│   ├── nei_sourcetypeyear.rds
│   ├── nei_sourcetypeyearvmt.rds
│   ├── nei_vmt_by_sourcetype_roadtype.rds
│   ├── sourcetypeyear.csv
│   ├── urban.rds
│   ├── urban_areas.rds
│   ├── VMT.rds
│   └── VPOP.rds
└── catr_0.2.0.tar.gz            # catr package distribution
```

## Launch Scripts

### launch.sh

The [launch.sh](../moves_anywhere/scripts/launch.sh) script is the main execution workflow for MOVES Anywhere.

**Purpose**: Orchestrates the complete MOVES run workflow

**Execution Order**:
1. Check inputs (`task_check_inputs.sh`)
2. Copy runspec (`task_copy_runspec.sh`)
3. Install catr package (`task_install_catr.R`)
4. Check R packages (`task_check_packages.R`)
5. Start MySQL (`task_start_mysql.sh`)
6. Adapt input tables (`task_adapt.R`)
7. Create custom database (`task_db_create.R`)
8. Create importer (`task_create_importer.R`)
9. Import tables (`task_importer.sh`)
10. Launch MOVES (`task_launch_moves.sh`)
11. Post-process output (`task_postprocess.R`)
12. Copy logs (`task_copy_logs.sh`)
13. Summarize results (`task_summarize.R`)

**Usage**:
```bash
./scripts/launch.sh
```

### launch_fuse.sh

The [launch_fuse.sh](../moves_anywhere/scripts/launch_fuse.sh) script runs MOVES Anywhere in cloud environments with Google Cloud Storage FUSE.

**Purpose**: Cloud execution workflow with GCS bucket mounting

**Differences from launch.sh**:
- Mounts GCS bucket with FUSE (`task_fuse.sh`)
- Uses `task_create_importer_fuse.R` instead of `task_create_importer.R`
- Uses `task_copy_inputs.sh` for cloud-specific input handling
- Sets environment variables via `setenv.R`

**Usage**:
```bash
./scripts/launch_fuse.sh
```

**Requirements**:
- `BUCKET` environment variable set
- Service account key file at `/cat/secret/moves-fuse.json`

### launch_runspec.sh

The [launch_runspec.sh](../moves_anywhere/scripts/launch_runspec.sh) script generates a runspec XML file without running MOVES.

**Purpose**: Generate runspec only (useful for testing runspec generation)

**Execution**:
1. Check R packages (`task_check_packages.R`)
2. Create runspec (`task_runspec.R`)

**Usage**:
```bash
./scripts/launch_runspec.sh
```

## Task Scripts (Shell)

### task_check_inputs.sh

The [task_check_inputs.sh](../moves_anywhere/scripts/task_check_inputs.sh) script validates that required input files are present.

**Purpose**: Quality check inputs folder before proceeding

**Checks**:
- `inputs/` folder exists
- `inputs/rs_custom.xml` exists

**Exit Codes**:
- `0` - All files present
- `1` - Missing files

### task_copy_runspec.sh

The [task_copy_runspec.sh](../moves_anywhere/scripts/task_copy_runspec.sh) script copies the runspec XML file to the MOVES directory.

**Purpose**: Copy runspec from inputs to MOVES model directory

### task_start_mysql.sh

The [task_start_mysql.sh](../moves_anywhere/scripts/task_start_mysql.sh) script starts the MySQL/MariaDB service.

**Purpose**: Start database service and wait for readiness

**Process**:
1. Start MySQL service
2. Wait for MySQL to respond to ping
3. Continue when ready

### task_launch_moves.sh

The [task_launch_moves.sh](../moves_anywhere/scripts/task_launch_moves.sh) script compiles and executes the MOVES model.

**Purpose**: Run MOVES simulation

**Process**:
1. Navigate to MOVES directory
2. Fix path separators in MOVESConfiguration.txt
3. Enable debug data retention
4. Verify Java configuration
5. Compile Java code (`ant clean`, `ant compileall`)
6. Compile Go code (`ant go64`)
7. Run MOVES with custom runspec (`ant run`)

### task_importer.sh

The [task_importer.sh](../moves_anywhere/scripts/task_importer.sh) script imports custom input tables into the MOVES database.

**Purpose**: Import CSV files using MOVES importer.xml

**Process**:
1. Navigate to MOVES directory
2. Fix path separators
3. Enable debug data
4. Compile MOVES
5. Copy importer.xml from inputs
6. Set permissions for MySQL user
7. Verify file access

### task_copy_logs.sh

The [task_copy_logs.sh](../moves_anywhere/scripts/task_copy_logs.sh) script copies MOVES log files to the inputs directory.

**Purpose**: Archive MOVES execution logs

### task_copy_inputs.sh

The [task_copy_inputs.sh](../moves_anywhere/scripts/task_copy_inputs.sh) script copies input files for cloud execution.

**Purpose**: Copy inputs from mounted GCS bucket to MOVES directory (cloud-specific)

### task_fuse.sh

The [task_fuse.sh](../moves_anywhere/scripts/task_fuse.sh) script mounts a Google Cloud Storage bucket using gcsfuse.

**Purpose**: Mount GCS bucket as local filesystem

**Process**:
1. Authenticate with service account
2. Set Google Cloud project
3. Create mount point
4. Mount bucket with gcsfuse
5. Set permissions for MySQL user
6. Verify mount

**Requirements**:
- `BUCKET` environment variable
- Service account key at `/cat/secret/moves-fuse.json`

### task_get_defaults.sh

The [task_get_defaults.sh](../moves_anywhere/scripts/task_get_defaults.sh) script retrieves default MOVES input data.

**Purpose**: Get default input tables from MOVES default database

### task_preview.sh

The [task_preview.sh](../moves_anywhere/scripts/task_preview.sh) script provides a preview mode for testing.

**Purpose**: Preview mode without full execution

### task_test_db.sh

The [task_test_db.sh](../moves_anywhere/scripts/task_test_db.sh) script tests database connectivity.

**Purpose**: Verify database connections and permissions

## Task Scripts (R)

### task_check_packages.R

The [task_check_packages.R](../moves_anywhere/scripts/task_check_packages.R) script verifies that required R packages are installed.

**Purpose**: Check R package availability

### task_install_catr.R

The [task_install_catr.R](../moves_anywhere/scripts/task_install_catr.R) script installs the catr package.

**Purpose**: Install catr package from local tar.gz file

**Process**:
1. Check if catr is installed
2. Install from `catr_0.2.0.tar.gz` if needed
3. Verify installation

### task_adapt.R

The [task_adapt.R](../moves_anywhere/scripts/task_adapt.R) script orchestrates input table adaptation.

**Purpose**: Adapt default MOVES inputs to custom geoid/year

**Process**:
1. Load adaptation functions
2. Adapt identifier tables (`adapt_ids.R`)
3. Adapt fuel tables (`adapt_fuel.R`)
4. Adapt vehicle population (`adapt_sourcetypeyear2.R`)
5. Adapt VMT tables (`adapt_vmt2.R`)
6. Adapt VMT fractions (`adapt_vmtfraction.R`)
7. Adapt age distributions (`adapt_sourcetypeagedistribution.R`)
8. Adapt road type distributions (`adapt_roadtypedistribution.R`)
9. Adapt other distributions (speed, starts, etc.)

**Dependencies**: All `adapt_*.R` scripts

### task_db_create.R

The [task_db_create.R](../moves_anywhere/scripts/task_db_create.R) script creates the custom MOVES database.

**Purpose**: Create custom database and output tables

**Process**:
1. Connect to MariaDB
2. Create `custom` database
3. Create input table schemas
4. Create output table schemas (from `defaults/CreateOutput.sql`)
5. Create output rates tables (from `defaults/CreateOutputRates.sql`)

### task_create_importer.R

The [task_create_importer.R](../moves_anywhere/scripts/task_create_importer.R) script generates the importer.xml file.

**Purpose**: Create MOVES importer XML from input CSV files

**Process**:
1. Scan inputs directory for CSV files
2. Generate importer.xml entries for each CSV
3. Write importer.xml to inputs directory

### task_create_importer_fuse.R

The [task_create_importer_fuse.R](../moves_anywhere/scripts/task_create_importer_fuse.R) script generates importer.xml for cloud execution.

**Purpose**: Same as `task_create_importer.R` but optimized for GCS FUSE mounts

### task_runspec.R

The [task_runspec.R](../moves_anywhere/scripts/task_runspec.R) script generates a runspec XML file.

**Purpose**: Create runspec using catr::custom_rs()

**Process**:
1. Read GEOID and YEAR from environment variables
2. Generate runspec with default pollutants
3. Save to `inputs/rs_custom.xml`

**Environment Variables**:
- `GEOID` - County/state FIPS code (required)
- `YEAR` - Analysis year (required)

### task_postprocess.R

The [task_postprocess.R](../moves_anywhere/scripts/task_postprocess.R) script post-processes MOVES output data.

**Purpose**: Format MOVES output into CAT format

**Process**:
1. Read runspec to determine mode (inventory vs. rates)
2. **Inventory Mode**:
   - Export movesoutput and movesactivityoutput to CSV
   - Check for parameters.json
   - Process data if parameters present
   - Generate data.csv
3. **Rates Mode**:
   - Export rate tables to CSV files
   - Export movesrun metadata

**Output Files**:
- `inputs/movesoutput.csv`
- `inputs/movesactivityoutput.csv`
- `inputs/data.csv` (if parameters.json present)
- Rate tables (if rates mode)

### task_summarize.R

The [task_summarize.R](../moves_anywhere/scripts/task_summarize.R) script generates summary statistics.

**Purpose**: Quick diagnostics and summary of MOVES run

### task_local_test.R

The [task_local_test.R](../moves_anywhere/scripts/task_local_test.R) script runs local testing.

**Purpose**: Test MOVES setup locally

### task_get_data.R

The [task_get_data.R](../moves_anywhere/scripts/task_get_data.R) script retrieves data from MOVES output.

**Purpose**: Helper function for data extraction

## Adaptation Scripts

Adaptation scripts modify default MOVES input tables to match custom geoid/year requirements.

### adapt_functions.R

The [adapt_functions.R](../moves_anywhere/scripts/adapt_functions.R) script contains shared utility functions used by all adaptation scripts.

**Purpose**: Common functions for input adaptation

### adapt_ids.R

The [adapt_ids.R](../moves_anywhere/scripts/adapt_ids.R) script adapts identifier tables (county, state, etc.).

**Purpose**: Set up geographic identifiers

### adapt_fuel.R

The [adapt_fuel.R](../moves_anywhere/scripts/adapt_fuel.R) script adapts fuel-related tables.

**Functions**:
- `adapt_fuelformulation()` - Fuel formulation data
- `adapt_fuelsupply()` - Fuel supply data
- `adapt_fuelusagefraction()` - Fuel usage fractions
- `adapt_avft()` - Alternative fuel types

### adapt_from_nei.R

The [adapt_from_nei.R](../moves_anywhere/scripts/adapt_from_nei.R) script provides functions to adapt data from National Emissions Inventory (NEI).

**Purpose**: Convert NEI data to MOVES format

**Functions**:
- `get_vmt1b()` - Interpolate VMT from NEI data
- `get_vmt2()` - Get VMT with extrapolation
- `get_vpop()` - Get vehicle population from NEI
- Helper functions for data interpolation

**Dependencies**: Reference data files in `reference/` directory

### adapt_sourcetypeyear.R / adapt_sourcetypeyear2.R

The [adapt_sourcetypeyear2.R](../moves_anywhere/scripts/adapt_sourcetypeyear2.R) script adapts vehicle population tables.

**Purpose**: Create sourcetypeyear table from NEI data or defaults

**Process**:
1. Read runspec to get geoid and year
2. Load NEI reference data or defaults
3. Interpolate/extrapolate for target year
4. Write CSV to inputs directory

### adapt_vmt.R / adapt_vmt2.R

The [adapt_vmt2.R](../moves_anywhere/scripts/adapt_vmt2.R) script adapts vehicle miles traveled tables.

**Purpose**: Create sourcetypeyearvmt table from NEI data or defaults

### adapt_vmtfraction.R

The [adapt_vmtfraction.R](../moves_anywhere/scripts/adapt_vmtfraction.R) script adapts VMT fraction tables.

**Functions**:
- `adapt_dayvmtfraction()` - Daily VMT fractions
- `adapt_hourvmtfraction()` - Hourly VMT fractions
- `adapt_monthvmtfraction()` - Monthly VMT fractions

### adapt_sourcetypeagedistribution.R

The [adapt_sourcetypeagedistribution.R](../moves_anywhere/scripts/adapt_sourcetypeagedistribution.R) script adapts vehicle age distribution tables.

**Purpose**: Create age distribution for vehicle populations

### adapt_roadtypedistribution.R

The [adapt_roadtypedistribution.R](../moves_anywhere/scripts/adapt_roadtypedistribution.R) script adapts road type distribution tables.

**Purpose**: Distribute VMT across road types

### adapt_avgspeeddistribution.R

The [adapt_avgspeeddistribution.R](../moves_anywhere/scripts/adapt_avgspeeddistribution.R) script adapts average speed distribution tables.

**Purpose**: Create speed distributions by road type

### adapt_starts.R

The [adapt_starts.R](../moves_anywhere/scripts/adapt_starts.R) script adapts vehicle start tables.

**Purpose**: Create vehicle start counts

### adapt_startsopmodedistribution.R

The [adapt_startsopmodedistribution.R](../moves_anywhere/scripts/adapt_startsopmodedistribution.R) script adapts start operating mode distributions.

**Purpose**: Distribute starts across operating modes

### adapt_hotellingactivitydistribution.R

The [adapt_hotellingactivitydistribution.R](../moves_anywhere/scripts/adapt_hotellingactivitydistribution.R) script adapts hotelling (idling) activity distributions.

**Purpose**: Create idling activity distributions

### adapt_totalidlefraction.R

The [adapt_totalidlefraction.R](../moves_anywhere/scripts/adapt_totalidlefraction.R) script adapts total idle fraction tables.

**Purpose**: Create idle fraction data

### adapt_imcoverage.R

The [adapt_imcoverage.R](../moves_anywhere/scripts/adapt_imcoverage.R) script adapts inspection/maintenance coverage tables.

**Purpose**: Create I/M program coverage data

### adapt_zonemonthhour.R

The [adapt_zonemonthhour.R](../moves_anywhere/scripts/adapt_zonemonthhour.R) script adapts zone-month-hour activity tables.

**Purpose**: Create temporal activity distributions

## Utility Scripts

### importer.R

The [importer.R](../moves_anywhere/scripts/importer.R) script provides importer utility functions.

**Purpose**: Helper functions for creating importer.xml

### importer_template.xml

The [importer_template.xml](../moves_anywhere/scripts/importer_template.xml) file is a template for MOVES importer XML.

**Purpose**: Template structure for importer.xml generation

### setenv.R

The [setenv.R](../moves_anywhere/scripts/setenv.R) script sets R environment variables.

**Purpose**: Configure R environment for MOVES execution

### make_projections.R

The [make_projections.R](../moves_anywhere/scripts/make_projections.R) script generates population projections.

**Purpose**: Create population projection data for future-year runs

### validate_adapt_from_nei.R

The [validate_adapt_from_nei.R](../moves_anywhere/scripts/validate_adapt_from_nei.R) script validates NEI adaptation functions.

**Purpose**: Test and validate NEI data adaptation

### validate_get_vmt3.R

The [validate_get_vmt3.R](../moves_anywhere/scripts/validate_get_vmt3.R) script validates VMT retrieval functions.

**Purpose**: Test VMT data extraction

### test.sh

The [test.sh](../moves_anywhere/scripts/test.sh) script provides testing utilities.

**Purpose**: Run tests on MOVES Anywhere setup

## Reference Data

The `reference/` directory contains reference data files used by adaptation scripts. See [reference/README.md](../moves_anywhere/scripts/reference/README.md) for details.

### Data Files

- **hpmsvtypeyear.csv** (10 KB) - HPMS vehicle type year data
- **nei_sourcetypeyear.rds** (1.1 MB) - NEI source type year data
- **nei_sourcetypeyearvmt.rds** (924 KB) - NEI source type year VMT data
- **nei_vmt_by_sourcetype_roadtype.rds** (2.5 MB) - NEI VMT by source type and road type
- **sourcetypeyear.csv** (25 KB) - Source type year reference data
- **urban.rds** (89.9 MB) - Urban area data
- **urban_areas.rds** (14.5 KB) - Urban area identifiers
- **VMT.rds** (5.3 MB) - Vehicle miles traveled reference data
- **VPOP.rds** (2.5 MB) - Vehicle population reference data

These files are created by the development tools (see [Development Tools Documentation](README_dev.md)) and used when custom input tables are not provided.

## Workflow Execution Order

### Standard Workflow (launch.sh)

```
1. task_check_inputs.sh          # Validate inputs
2. task_copy_runspec.sh           # Copy runspec
3. task_install_catr.R           # Install catr package
4. task_check_packages.R          # Verify R packages
5. task_start_mysql.sh            # Start database
6. task_adapt.R                   # Adapt input tables
   ├── adapt_ids.R
   ├── adapt_fuel.R
   ├── adapt_sourcetypeyear2.R
   ├── adapt_vmt2.R
   ├── adapt_vmtfraction.R
   └── [other adapt scripts]
7. task_db_create.R               # Create custom database
8. task_create_importer.R         # Generate importer.xml
9. task_importer.sh               # Import CSV files
10. task_launch_moves.sh          # Run MOVES
11. task_postprocess.R             # Format output
12. task_copy_logs.sh             # Archive logs
13. task_summarize.R              # Generate summary
```

### Cloud Workflow (launch_fuse.sh)

```
1. task_fuse.sh                   # Mount GCS bucket
2. task_check_inputs.sh           # Validate inputs
3. task_copy_runspec.sh           # Copy runspec
4. setenv.sh / setenv.R           # Set environment
5. task_install_catr.R            # Install catr package
6. task_check_packages.R          # Verify R packages
7. task_start_mysql.sh            # Start database
8. task_adapt.R                   # Adapt input tables
9. task_db_create.R               # Create custom database
10. task_copy_inputs.sh            # Copy inputs (cloud)
11. task_create_importer_fuse.R   # Generate importer (cloud)
12. task_importer.sh              # Import CSV files
13. task_launch_moves.sh          # Run MOVES
14. task_postprocess.R            # Format output
15. task_copy_logs.sh             # Archive logs
16. task_summarize.R              # Generate summary
```

## Configuration

### Environment Variables

Required environment variables:
- `GEOID` - County/state FIPS code (e.g., "36109")
- `YEAR` - Analysis year (e.g., 2020)
- `BUCKET` - GCS bucket name (for cloud execution)
- `MDB_USERNAME` - Database username (default: "moves")
- `MDB_PASSWORD` - Database password (default: "moves")
- `MDB_HOST` - Database host (default: "localhost")
- `MDB_PORT` - Database port (default: 3306)

### Input Files

Required input files:
- `inputs/rs_custom.xml` - MOVES runspec file
- `inputs/parameters.json` - (Optional) Post-processing parameters

Optional input files (CSV format):
- `inputs/sourcetypeyear.csv`
- `inputs/sourcetypeyearvmt.csv`
- `inputs/fuelformulation.csv`
- `inputs/fuelsupply.csv`
- `inputs/fuelusagefraction.csv`
- `inputs/avft.csv`
- `inputs/dayvmtfraction.csv`
- `inputs/hourvmtfraction.csv`
- `inputs/monthvmtfraction.csv`
- `inputs/sourcetypeagedistribution.csv`
- `inputs/roadtypedistribution.csv`
- `inputs/avgspeeddistribution.csv`
- `inputs/starts.csv`
- `inputs/startsopmodedistribution.csv`
- `inputs/hotellingactivitydistribution.csv`
- `inputs/totalidlefraction.csv`
- `inputs/imcoverage.csv`
- `inputs/zonemonthhour.csv`

If CSV files are not provided, adaptation scripts will use default or NEI reference data.

## Dependencies

### External Dependencies
- MOVES Model (in Docker image)
- MySQL/MariaDB (in Docker image)
- R and R packages (in Docker image)
- catr package (installed by task_install_catr.R)

### Internal Dependencies
- Reference data files (in `reference/` directory)
- Default SQL schemas (in `defaults/` directory)
- catr package tar.gz (in `scripts/` directory)

## Related Documentation

- [Main README](../README.md)
- [catr Package Documentation](README_catr.md)
- [Docker Image Documentation](README_docker_moves.md)
- [Development Tools Documentation](README_dev.md)
- [Reference Data README](../moves_anywhere/scripts/reference/README.md)

