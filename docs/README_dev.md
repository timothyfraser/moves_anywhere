# Development Tools Documentation

**AI Disclosure**: This documentation was generated by AI with Cursor.

## Overview

The `dev/` directory contains development utilities and reference materials for creating supporting data files used by MOVES Anywhere. These tools help generate reference data from external sources, particularly the National Emissions Inventory (NEI).

**Location**: `moves_anywhere/dev/`

## Directory Structure

```
dev/
├── make_nei.R                              # Script to download and process NEI data
├── README.md                               # Brief documentation
├── SCC.xlsx                                # Source Classification Code reference file (Excel)
├── SCC.csv                                 # Source Classification Code reference file (CSV)
├── VMT.rds                                 # Processed VMT reference data (RDS format)
├── VPOP.rds                               # Processed vehicle population reference data (RDS format)
├── nei_sourcetypeyear.rds                  # NEI source type year data (RDS format)
├── nei_sourcetypeyearvmt.rds               # NEI source type year VMT data (RDS format)
├── nei_vmt_by_sourcetype_roadtype.rds      # NEI VMT by source type and road type (RDS format)
├── VMT_2011NEI.csv                        # NEI VMT data for 2011
├── VMT_2014NEI.csv                        # NEI VMT data for 2014
├── VMT_2017NEI.csv                        # NEI VMT data for 2017
├── VMT_2020NEI.csv                        # NEI VMT data for 2020
├── VPOP_2011NEI.csv                       # NEI vehicle population data for 2011
├── VPOP_2014NEI.csv                       # NEI vehicle population data for 2014
├── VPOP_2017NEI.csv                       # NEI vehicle population data for 2017
├── VPOP_2020NEI.csv                       # NEI vehicle population data for 2020
├── HOTELING_2014NEI.csv                   # NEI hotelling (idling) data for 2014
├── HOTELING_2017NEI.csv                   # NEI hotelling (idling) data for 2017
├── HOTELING_2020NEI.csv                   # NEI hotelling (idling) data for 2020
├── SPEED_2014NEI.csv                      # NEI speed distribution data for 2014
├── STARTS_2020NEI.csv                     # NEI vehicle starts data for 2020
└── ONI_2020NEI.csv                        # NEI other data for 2020
```

## Files

### make_nei.R

The [make_nei.R](../moves_anywhere/dev/make_nei.R) script downloads and processes National Emissions Inventory (NEI) on-road activity data for use as reference inputs in MOVES Anywhere.

#### Purpose

This script creates reference data files for:
- **sourcetypeyear** - Vehicle population by source type and year
- **sourcetypeyearvmt** - Vehicle miles traveled by source type and year

These reference files are used by adaptation scripts (see [Scripts Documentation](README_scripts.md)) when custom input tables are not provided.

#### Data Sources

The script downloads NEI on-road activity data from:
- **2020 NEI**: `https://gaftp.epa.gov/air/nei/2020/doc/supporting_data/onroad/2020NEI_onroad_activity_final_20230112.zip`
- **2017 NEI**: `https://gaftp.epa.gov/air/nei/2017/doc/supporting_data/onroad/2017NEI_onroad_activity_final.zip`
- **2014 NEI**: `https://gaftp.epa.gov/air/nei/2014/doc/2014v2_supportingdata/onroad/2014v2_onroad_activity_final.zip`
- **2011 NEI**: `https://gaftp.epa.gov/air/nei/2011/doc/2011v2_supportingdata/onroad/2011neiv2_supdata_or_VMT.zip`

#### Process

1. **Download NEI Data**: Downloads ZIP files from EPA FTP server (commented out by default - uncomment to download)
2. **Process SCC Codes**: Reads `SCC.xlsx` to map Source Classification Codes to MOVES source types
3. **Format VMT Data**: Processes VMT data from NEI CSV files
4. **Format VPOP Data**: Processes vehicle population data from NEI files
5. **Format Source Type Year Data**: Creates `sourcetypeyear` reference tables
6. **Format Source Type Year VMT Data**: Creates `sourcetypeyearvmt` reference tables
7. **Save Output**: Saves processed data as `.rds` files for use by adaptation scripts

#### Output Files

The script generates reference data files that are used by:
- `adapt_from_nei.R` - Adapts NEI data to MOVES format
- `adapt_sourcetypeyear2.R` - Creates sourcetypeyear tables from NEI data
- `adapt_vmt2.R` - Creates VMT tables from NEI data

#### Usage

```r
# Set working directory to moves_anywhere
setwd("path/to/moves_anywhere")

# Uncomment download lines if needed
# download.file(url = "...", destfile = "dev/2020.zip")

# Run the script
source("dev/make_nei.R")
```

#### Dependencies

Required R packages:
- `dplyr` - Data manipulation
- `readr` - CSV file reading
- `tidyr` - Data reshaping
- `stringr` - String manipulation
- `purrr` - Functional programming
- `readxl` - Excel file reading

### SCC.xlsx

The [SCC.xlsx](../moves_anywhere/dev/SCC.xlsx) file is a reference spreadsheet containing Source Classification Code mappings.

#### Structure

The Excel file contains multiple sheets:
- **VMT** - VMT data by SCC code
- **HOTELLING** - Hotelling (idling) activity by SCC code
- **VPOP** - Vehicle population by SCC code

#### Purpose

This file maps EPA Source Classification Codes (SCCs) to MOVES source types, allowing conversion of NEI data (which uses SCCs) to MOVES input format (which uses sourceTypeIDs).

#### Usage

The `make_nei.R` script reads this file to:
1. Map SCC codes to MOVES source types
2. Aggregate NEI data by MOVES source types
3. Create reference data files compatible with MOVES

### SCC.csv

The [SCC.csv](../moves_anywhere/dev/SCC.csv) file is a CSV version of the SCC.xlsx file, containing Source Classification Code mappings in a format suitable for programmatic processing.

### Processed Reference Data Files (.rds)

The following `.rds` files contain processed reference data used by adaptation scripts:

- **[VMT.rds](../moves_anywhere/dev/VMT.rds)** (5.3 MB) - Processed vehicle miles traveled data aggregated from multiple NEI years
- **[VPOP.rds](../moves_anywhere/dev/VPOP.rds)** (2.5 MB) - Processed vehicle population data aggregated from multiple NEI years
- **[nei_sourcetypeyear.rds](../moves_anywhere/dev/nei_sourcetypeyear.rds)** (1.1 MB) - NEI source type year data processed for MOVES compatibility
- **[nei_sourcetypeyearvmt.rds](../moves_anywhere/dev/nei_sourcetypeyearvmt.rds)** (924 KB) - NEI source type year VMT data processed for MOVES compatibility
- **[nei_vmt_by_sourcetype_roadtype.rds](../moves_anywhere/dev/nei_vmt_by_sourcetype_roadtype.rds)** (2.5 MB) - NEI VMT data broken down by source type and road type

These files are generated by `make_nei.R` and are used by adaptation scripts when custom input tables are not provided.

### Raw NEI Data Files (.csv)

The directory contains raw NEI data files downloaded from the EPA FTP server:

**VMT Data Files:**
- **[VMT_2011NEI.csv](../moves_anywhere/dev/VMT_2011NEI.csv)** (59 MB) - Vehicle miles traveled data from 2011 NEI
- **[VMT_2014NEI.csv](../moves_anywhere/dev/VMT_2014NEI.csv)** (59.7 MB) - Vehicle miles traveled data from 2014 NEI
- **[VMT_2017NEI.csv](../moves_anywhere/dev/VMT_2017NEI.csv)** (76.6 MB) - Vehicle miles traveled data from 2017 NEI
- **[VMT_2020NEI.csv](../moves_anywhere/dev/VMT_2020NEI.csv)** (71.1 MB) - Vehicle miles traveled data from 2020 NEI

**Vehicle Population Data Files:**
- **[VPOP_2011NEI.csv](../moves_anywhere/dev/VPOP_2011NEI.csv)** (3.5 MB) - Vehicle population data from 2011 NEI
- **[VPOP_2014NEI.csv](../moves_anywhere/dev/VPOP_2014NEI.csv)** (3.2 MB) - Vehicle population data from 2014 NEI
- **[VPOP_2017NEI.csv](../moves_anywhere/dev/VPOP_2017NEI.csv)** (14.9 MB) - Vehicle population data from 2017 NEI
- **[VPOP_2020NEI.csv](../moves_anywhere/dev/VPOP_2020NEI.csv)** (13.5 MB) - Vehicle population data from 2020 NEI

**Other NEI Data Files:**
- **[HOTELING_2014NEI.csv](../moves_anywhere/dev/HOTELING_2014NEI.csv)** (1.0 MB) - Hotelling (idling) activity data from 2014 NEI
- **[HOTELING_2017NEI.csv](../moves_anywhere/dev/HOTELING_2017NEI.csv)** (391 KB) - Hotelling (idling) activity data from 2017 NEI
- **[HOTELING_2020NEI.csv](../moves_anywhere/dev/HOTELING_2020NEI.csv)** (910 KB) - Hotelling (idling) activity data from 2020 NEI
- **[SPEED_2014NEI.csv](../moves_anywhere/dev/SPEED_2014NEI.csv)** (90.4 MB) - Speed distribution data from 2014 NEI
- **[STARTS_2020NEI.csv](../moves_anywhere/dev/STARTS_2020NEI.csv)** (21.9 MB) - Vehicle starts data from 2020 NEI
- **[ONI_2020NEI.csv](../moves_anywhere/dev/ONI_2020NEI.csv)** (20.4 MB) - Other NEI data from 2020

These raw CSV files are processed by `make_nei.R` to create the aggregated `.rds` reference files used by the adaptation scripts.

## Workflow Integration

### Reference Data Creation

1. **Download NEI Data**: Use `make_nei.R` to download NEI on-road activity files
2. **Process Data**: Script processes and formats data for MOVES
3. **Save Reference Files**: Output saved as `.rds` files in `scripts/reference/` directory

### Usage in MOVES Runs

When running MOVES with custom inputs:
1. If custom `sourcetypeyear` or `sourcetypeyearvmt` tables are not provided
2. Adaptation scripts (`adapt_from_nei.R`, `adapt_sourcetypeyear2.R`, `adapt_vmt2.R`) use NEI reference data
3. Reference data is adapted to match the runspec geoid and year
4. Adapted data is inserted into the custom MOVES database

## NEI Data Sources

### EPA FTP Server

NEI data is available from:
- **Base URL**: `https://gaftp.epa.gov/air/nei/`
- **On-road Data**: `{YEAR}/doc/supporting_data/onroad/`

### Available Years

- 2020 (latest)
- 2017
- 2014
- 2011
- Earlier years available but may require different processing

### Data Files

Each NEI release includes:
- **VMT Data**: Vehicle miles traveled by county, SCC, and year
- **VPOP Data**: Vehicle population by county, SCC, and year
- **Hotelling Data**: Idling activity by county, SCC, and year

## Development Notes

### Updating Reference Data

To update reference data with newer NEI releases:

1. **Download New Data**:
   ```r
   # In make_nei.R, uncomment download lines for new year
   download.file(url = "NEW_URL", destfile = "dev/NEW_YEAR.zip")
   ```

2. **Update Processing**:
   - Check if NEI file format has changed
   - Update column mappings if needed
   - Test with sample counties

3. **Regenerate Reference Files**:
   ```r
   source("dev/make_nei.R")
   ```

4. **Test Adaptation**:
   - Run MOVES with a test county
   - Verify adapted data looks correct
   - Check MOVES run completes successfully

### SCC Code Mapping

If SCC codes change in new NEI releases:
1. Update `SCC.xlsx` with new mappings
2. Verify mappings match MOVES source types
3. Test conversion with sample data

## Related Documentation

- [Scripts Documentation](README_scripts.md) - Details on adaptation scripts that use this data
- [catr Package Documentation](README_catr.md) - R package used for data processing
- [Main README](../README.md) - Overall project documentation

## References

- **NEI Documentation**: [EPA National Emissions Inventory](https://www.epa.gov/air-emissions-inventories/national-emissions-inventory-nei)
- **MOVES Documentation**: [EPA MOVES Model](https://www.epa.gov/moves)
- **SCC Codes**: [EPA Source Classification Codes](https://www.epa.gov/air-emissions-inventories/air-pollutant-emissions-trends-data)

## Maintenance

### Regular Updates

Reference data should be updated when:
- New NEI releases are available
- MOVES source type definitions change
- SCC code mappings are updated

### Version Control

- Keep `SCC.xlsx` in version control
- Document changes to SCC mappings
- Tag releases when reference data is updated

