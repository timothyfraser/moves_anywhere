# docker_moves Base Image Documentation

**AI Disclosure**: This documentation was generated by AI with Cursor.

## Overview

The `docker_moves` directory contains the base Docker image configuration for MOVES Anywhere. This image (`tmf77/docker_moves:v2`) provides a pre-configured environment with all MOVES dependencies installed, ready to run MOVES simulations on any operating system (Windows, Mac, or Linux).

**Image Name**: `tmf77/docker_moves:v2`  
**Base OS**: Ubuntu 20.04  
**MOVES Version**: MOVES 5.0 (from EPA repository)

## Purpose

This base image contains:
- MOVES Model software (cloned from EPA GitHub repository)
- MOVES default database (`movesdb20241112`)
- All required system dependencies
- R and essential R packages
- MariaDB/MySQL database server
- Java and Go toolchains for MOVES compilation

Unlike the `moves_anywhere` cloud image, this base image does **not** include:
- Custom scripts (these are mounted at runtime)
- Google Cloud SDK and gcsfuse
- Pre-installed `catr` package

## Directory Structure

```
docker_moves/
├── Dockerfile              # Image definition
├── buildme.sh              # Build script
├── testme.sh               # Testing script
├── setupdb.sh              # Database setup script
├── setenv.sh               # Environment configuration (shell)
├── setenv.r                # Environment configuration (R)
├── my.cnf                  # MySQL/MariaDB configuration
├── pushme.sh               # Push script (optional)
├── .dockerignore           # Files to exclude from build
└── .gitignore              # Git ignore patterns
```

## Files

### Dockerfile

The [Dockerfile](../docker_moves/Dockerfile) defines the image build process:

1. **Base Image**: Ubuntu 20.04
2. **System Dependencies**:
   - MariaDB server
   - OpenJDK 11
   - Go compiler
   - Git, Ant, Unzip
   - MySQL/MariaDB development libraries
   - XML2 development libraries
   - SSL and curl development libraries

3. **R Installation**:
   - Adds CRAN repository
   - Installs latest R version
   - Installs R packages: remotes, dplyr, readr, tidyr, purrr, lubridate, stringr, vroom, xml2, jsonlite, dbplyr, RMariaDB, RMySQL, httr, gargle, googleAuthR, googleCloudStorageR

4. **MOVES Installation**:
   - Clones EPA MOVES Model repository
   - Extracts MOVES database dump (`movesdb20241112.zip`)
   - Sets up MOVES environment

5. **Database Setup**:
   - Configures MySQL/MariaDB
   - Runs database initialization scripts
   - Creates default MOVES database

### buildme.sh

The [buildme.sh](../docker_moves/buildme.sh) script builds the Docker image:

- Sets up paths and image naming
- Converts line endings (dos2unix) for cross-platform compatibility
- Builds image using Docker Buildx (with cloud builder support)
- Prunes dangling images after build

**Usage**:
```bash
cd docker_moves
./buildme.sh
```

### setupdb.sh

The [setupdb.sh](../docker_moves/setupdb.sh) script initializes the MOVES database:

1. Starts MySQL service
2. Waits for MySQL to be ready
3. Creates `moves` database if it doesn't exist
4. Runs MOVES database setup scripts
5. Creates output database tables
6. Configures environment variables
7. Stops MySQL service

This script is run during image build to pre-configure the database.

### setenv.sh

The [setenv.sh](../docker_moves/setenv.sh) script sets MOVES environment variables:

- `PATH` - Adds Java and Ant to PATH
- `JAVA_TOOL_OPTIONS` - Sets UTF-8 encoding
- `ANT_OPTS` - Configures Ant memory settings
- `JAVA_HOME` - Sets Java home directory
- `JRE_HOME` - Sets JRE home directory

### setenv.r

The [setenv.r](../docker_moves/setenv.r) script sets R environment variables for MOVES database connections.

### my.cnf

The [my.cnf](../docker_moves/my.cnf) file configures MySQL/MariaDB server settings optimized for MOVES operations.

### testme.sh

The [testme.sh](../docker_moves/testme.sh) script tests the Docker container:

- Runs container interactively
- Tests R package installations
- Verifies required packages are available

**Usage**:
```bash
cd docker_moves
./testme.sh
```

## Image Contents

### Installed Software

- **Operating System**: Ubuntu 20.04
- **MOVES Model**: Latest version from [EPA_MOVES_Model](https://github.com/USEPA/EPA_MOVES_Model) repository
- **MOVES Database**: `movesdb20241112` (default input database)
- **R**: Latest version from CRAN
- **MariaDB/MySQL**: Database server for MOVES
- **Java**: OpenJDK 11
- **Go**: Go compiler for MOVES components
- **Ant**: Build tool for MOVES compilation

### R Packages

The image includes these R packages:
- **Data Manipulation**: dplyr, tidyr, readr, purrr, lubridate, stringr, vroom
- **Database**: DBI, dbplyr, RMariaDB, RMySQL
- **Utilities**: jsonlite, xml2
- **Cloud**: googleCloudStorageR, googleAuthR, gargle, httr
- **Package Management**: remotes

### Database Configuration

- **Default Database**: `movesdb20241112` (MOVES default input database)
- **Output Database**: `moves` (created during setup)
- **User**: `moves` / `moves` (username/password)
- **Port**: 3306 (default MySQL port)
- **Host**: localhost

## Build Process

1. **Prerequisites**:
   - Docker installed
   - Docker Buildx configured (optional, for cloud builds)
   - Git access to EPA MOVES repository

2. **Build Steps**:
   ```bash
   cd docker_moves
   ./buildme.sh
   ```

3. **Build Time**: Approximately 30-60 minutes (depending on network speed)

4. **Image Size**: ~5-8 GB (includes MOVES model and database)

## Usage

### Basic Usage

```bash
docker run --rm -it tmf77/docker_moves:v2
```

### With Mounted Scripts

```bash
docker run --rm \
  --mount src="$(pwd)/moves_anywhere/scripts",target="/cat/scripts",type=bind \
  --mount src="$(pwd)/moves_anywhere/inputs",target="/cat/inputs",type=bind \
  tmf77/docker_moves:v2 \
  /bin/bash -c "/cat/scripts/launch.sh"
```

### Environment Variables

The image uses these environment variables (set via `setenv.sh`):
- `JAVA_HOME` - Java installation path
- `JRE_HOME` - JRE installation path
- `PATH` - Includes Java and Ant binaries

## Differences from moves_anywhere Cloud Image

| Feature | docker_moves (base) | moves_anywhere (cloud) |
|---------|---------------------|------------------------|
| Scripts | Not included | Included in image |
| Google Cloud SDK | Not included | Included |
| gcsfuse | Not included | Included |
| catr package | Not pre-installed | Pre-installed |
| Use Case | Base for custom builds | Cloud execution |

## Troubleshooting

### Database Connection Issues

If MySQL fails to start:
```bash
# Check MySQL status
service mysql status

# Start MySQL manually
service mysql start
```

### R Package Issues

If R packages are missing:
```r
# Install missing packages
install.packages("package_name", repos = "http://cran.us.r-project.org")
```

### MOVES Compilation Issues

If MOVES fails to compile:
```bash
# Check Java version
java -version

# Check Ant installation
ant -version

# Recompile MOVES
cd /cat/EPA_MOVES_Model
ant clean
ant compileall
ant go64
```

## Related Documentation

- [Main README](../README.md)
- [catr Package Documentation](README_catr.md)
- [Scripts Documentation](README_scripts.md)
- [Development Tools Documentation](README_dev.md)

## Maintenance

### Updating MOVES Version

To update to a newer MOVES version:
1. Update the database dump filename in `Dockerfile`
2. Rebuild the image
3. Test with sample runs

### Updating R Packages

To update R packages:
1. Modify `Dockerfile` to install newer versions
2. Rebuild the image
3. Test package compatibility

## Image Tags

- `v2` - Current stable version (MOVES 5.0)
- `latest` - Alias for `v2`

## Support

For issues or questions:
- **Maintainer**: Tim Fraser <tmf77@cornell.edu>
- **Repository**: [moves_anywhere](https://github.com/gao-labs/movesanywhere)

